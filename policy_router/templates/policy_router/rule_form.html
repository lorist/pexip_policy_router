<!-- policy_router/templates/policy_router/rule_form.html -->
{% extends "policy_router/base.html" %}
{% block title %}Rule{% endblock %}
{% block content %}

<h2>{% if form.instance.pk %}Edit{% else %}Create{% endif %} Rule</h2>

<form method="post" class="needs-validation">
  {% csrf_token %}

  <!-- Match Criteria -->
  <div class="card mb-4">
    <div class="card-header">
      <strong>Match Criteria</strong>
    </div>
    <div class="card-body">
      <div class="row g-3 mb-3">
        <div class="col-md-6">
          {{ form.name.label_tag }}
          {{ form.name }}
          {% if form.name.help_text %}
            <div class="form-text">{{ form.name.help_text }}</div>
          {% endif %}
        </div>
        <div class="col-md-6">
          {{ form.regex.label_tag }}
          {{ form.regex }}
          {% if form.regex.help_text %}
            <div class="form-text">{{ form.regex.help_text }}</div>
          {% endif %}
        </div>
      </div>
      <div class="mb-3">
        <label for="{{ form.protocols.id_for_label }}" class="form-label">Protocols</label>
        <div class="input-group">
          {{ form.protocols }}
          <button
            type="button"
            class="btn btn-outline-secondary clear-multiselect"
            data-target-id="{{ form.protocols.id_for_label }}"
          >
            ðŸ§¹ Clear
          </button>
        </div>
        <div class="form-text">{{ form.protocols.help_text }}</div>
        <div class="mb-3">
          {{ form.source_match.label_tag }}
          {{ form.source_match }}
          <div class="form-text">
            Optional source IP or FQDN of the Infinity node. Leave empty to match any source.
          </div>
        </div>
      </div>

      <div class="mb-3">
        <label for="{{ form.call_directions.id_for_label }}" class="form-label">Call Directions</label>
        <div class="input-group">
          {{ form.call_directions }}
          <button
            type="button"
            class="btn btn-outline-secondary clear-multiselect"
            data-target-id="{{ form.call_directions.id_for_label }}"
          >
            ðŸ§¹ Clear
          </button>
        </div>
        <div class="form-text">{{ form.call_directions.help_text }}</div>
      </div>

    </div>
  </div>

  <!-- Service policy -->
  <div class="card mb-4">
    <div class="card-header">
      <strong>Service Policy</strong>
    </div>
    <div class="card-body row g-3">
      <div class="col-md-6">
        {{ form.service_target_url.label_tag }}
        {{ form.service_target_url }}
        <div class="form-text">Target URL for forwarding service policy requests.</div>
      </div>
      <div class="col-md-6">
        {{ form.always_continue_service }} {{ form.always_continue_service.label_tag }}
        <div class="form-text">Always return a static response instead of proxying.</div>
        <div class="mt-2" id="service-override-container">
          {{ form.override_service_response.label_tag }}
          {{ form.override_service_response }}
          <button type="button" class="btn btn-outline-secondary btn-sm mt-2 open-json-editor" data-target="id_override_service_response">
            Open JSON Editor
          </button>
          <div class="form-text">Custom JSON response if "Custom response" is enabled.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Participant policy -->
  <div class="card mb-4">
    <div class="card-header">
      <strong>Participant Policy</strong>
    </div>
    <div class="card-body row g-3">
      <div class="col-md-6">
        {{ form.participant_target_url.label_tag }}
        {{ form.participant_target_url }}
        <div class="form-text">Target URL for forwarding participant policy requests.</div>
      </div>
      <div class="col-md-6">
        {{ form.always_continue_participant }} {{ form.always_continue_participant.label_tag }}
        <div class="form-text">Always return a static response instead of proxying.</div>
        <div class="mt-2" id="participant-override-container">
          {{ form.override_participant_response.label_tag }}
          {{ form.override_participant_response }}
          <button type="button" class="btn btn-outline-secondary btn-sm mt-2 open-json-editor" data-target="id_override_participant_response">
            Open JSON Editor
          </button>


          <div class="form-text">Custom JSON response if "Custom response" is enabled.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Authentication -->
  <div class="card mb-4">
    <div class="card-header">
      <strong>Authentication</strong>
    </div>
    <div class="card-body row g-3">
      <div class="col-md-6">
        {{ form.basic_auth_username.label_tag }}
        {{ form.basic_auth_username }}
        <div class="form-text">Optional basic auth username for upstream target requests.</div>
      </div>
      <div class="col-md-6">
        {{ form.basic_auth_password.label_tag }}
        {{ form.basic_auth_password }}
        <div class="form-text">Optional basic auth password for upstream target requests.</div>
      </div>
    </div>
  </div>

  <!-- Management -->
  <div class="card mb-4">
    <div class="card-header">
      <strong>Management</strong>
    </div>
    <div class="card-body row g-3">
      <div class="col-md-3">
        {{ form.priority.label_tag }}
        {{ form.priority }}
        <div class="form-text">Lower numbers are matched first. Default is 100.</div>
      </div>
      <div class="col-md-3">
        {{ form.is_active.label_tag }}
        {{ form.is_active }}
        <div class="form-text">Only active rules are evaluated.</div>
      </div>
      <div class="col-md-6">
        <div class="form-check mt-4">
          {{ form.use_advanced_logic }}
          <label class="form-check-label" for="{{ form.use_advanced_logic.id_for_label }}">
            {{ form.use_advanced_logic.label }}
          </label>
          <div class="form-text">{{ form.use_advanced_logic.help_text }}</div>
        </div>
      </div>
    </div>
  </div>

  <!-- JSON Editor Modal -->
  <div class="modal fade" id="jsonEditorModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Edit JSON Response</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body p-0">
          <textarea id="jsonEditorTextarea"></textarea>
          <div id="jsonEditorError" class="invalid-feedback d-block text-danger p-3"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="saveJsonEditorBtn">Save Changes</button>
        </div>
      </div>
    </div>
  </div>
  <!-- Actions -->
  <div class="mt-3">
    <button type="submit" class="btn btn-primary btn-sm">Save</button>
    <a href="{% url 'policy_router:rule_list' %}" class="btn btn-secondary btn-sm">Cancel</a>
  </div>
</form>

<script>
document.addEventListener("DOMContentLoaded", function() {
  // === Elements ===
  const serviceToggle = document.querySelector("[name=always_continue_service]");
  const serviceContainer = document.getElementById("service-override-container");
  const serviceInput = document.getElementById("id_override_service_response");

  const participantToggle = document.querySelector("[name=always_continue_participant]");
  const participantContainer = document.getElementById("participant-override-container");
  const participantInput = document.getElementById("id_override_participant_response");

  const serviceError = document.createElement("div");
  serviceError.className = "invalid-feedback";
  serviceInput.insertAdjacentElement("afterend", serviceError);

  const participantError = document.createElement("div");
  participantError.className = "invalid-feedback";
  participantInput.insertAdjacentElement("afterend", participantError);

  // === Detect current theme (from base.html toggle) ===
  function getTheme() {
    return document.documentElement.getAttribute("data-bs-theme") === "dark" ? "dracula" : "eclipse";
  }

  // === Auto-resize ===
  function autoResize(textarea) {
    textarea.style.height = "auto";
    textarea.style.height = textarea.scrollHeight + "px";
  }
  [serviceInput, participantInput].forEach(el => {
    el.addEventListener("input", () => autoResize(el));
    autoResize(el);
  });

  // === Pretty Print JSON on load ===
  function prettyPrintOnLoad(input) {
    if (!input || !input.value.trim()) return;
    try {
      const parsed = JSON.parse(input.value);
      input.value = JSON.stringify(parsed, null, 2);
      autoResize(input);
    } catch {}
  }
  prettyPrintOnLoad(serviceInput);
  prettyPrintOnLoad(participantInput);

  // === Toggle + Default Handling ===
  function toggleVisibility(toggle, container, input) {
    if (toggle.checked) {
      container.style.display = "block";
      if (!input.value.trim()) {
        input.value = JSON.stringify({ status: "success", action: "continue" }, null, 2);
      }
      autoResize(input);
    } else {
      container.style.display = "none";
      input.value = "";
      input.classList.remove("is-invalid", "is-valid");
    }
  }
  [[serviceToggle, serviceContainer, serviceInput],
   [participantToggle, participantContainer, participantInput]
  ].forEach(([toggle, container, input]) => {
    toggle.addEventListener("change", () => toggleVisibility(toggle, container, input));
    toggleVisibility(toggle, container, input);
  });

  // === Inline JSON Validation ===
  function validateJSON(input, errorDiv) {
    const val = input.value.trim();
    if (!val) {
      input.classList.remove("is-invalid", "is-valid");
      errorDiv.textContent = "";
      return true;
    }
    try {
      JSON.parse(val);
      input.classList.add("is-valid");
      input.classList.remove("is-invalid");
      errorDiv.textContent = "";
      return true;
    } catch {
      input.classList.add("is-invalid");
      input.classList.remove("is-valid");
      errorDiv.textContent = "Invalid JSON format.";
      return false;
    }
  }

  [[serviceInput, serviceError],
   [participantInput, participantError]
  ].forEach(([input, err]) =>
    input.addEventListener("input", () => {
      validateJSON(input, err);
      autoResize(input);
    })
  );

  // === CodeMirror JSON Editor Modal ===
  const modalEl = document.getElementById("jsonEditorModal");
  const modal = new bootstrap.Modal(modalEl);
  const errorDiv = document.getElementById("jsonEditorError");
  const saveBtn = document.getElementById("saveJsonEditorBtn");
  const editorTextarea = document.getElementById("jsonEditorTextarea");

  let cm = null;
  let activeTextarea = null;

  function checkEditorJSON() {
    const text = cm.getValue();
    try {
      JSON.parse(text);
      cm.getWrapperElement().style.border = "2px solid #28a745";
      errorDiv.textContent = "";
      saveBtn.disabled = false;
      return true;
    } catch {
      cm.getWrapperElement().style.border = "2px solid #dc3545";
      errorDiv.textContent = "Invalid JSON format.";
      saveBtn.disabled = true;
      return false;
    }
  }

  function initCodeMirror() {
    if (cm) return cm;
    cm = CodeMirror.fromTextArea(editorTextarea, {
      mode: { name: "javascript", json: true },
      lineNumbers: true,
      tabSize: 2,
      theme: getTheme(),
      autoCloseBrackets: true,
    });
    cm.setSize("100%", "70vh");
    cm.on("change", checkEditorJSON);
    return cm;
  }

  // Open JSON Editor Modal
  document.querySelectorAll(".open-json-editor").forEach(btn => {
    btn.addEventListener("click", () => {
      const targetId = btn.getAttribute("data-target");
      activeTextarea = document.getElementById(targetId);

      initCodeMirror();

      // Sync theme
      cm.setOption("theme", getTheme());

      // Load content
      let content = activeTextarea.value.trim();
      try {
        const parsed = JSON.parse(content);
        content = JSON.stringify(parsed, null, 2);
      } catch {}
      cm.setValue(content);
      errorDiv.textContent = "";
      saveBtn.disabled = false;

      modal.show();
      setTimeout(() => cm.refresh(), 200);
      checkEditorJSON();
    });
  });

  // Save from JSON Editor
  saveBtn.addEventListener("click", () => {
    if (!checkEditorJSON()) return;
    const formatted = JSON.stringify(JSON.parse(cm.getValue()), null, 2);
    activeTextarea.value = formatted;
    validateJSON(
      activeTextarea,
      activeTextarea.id === "id_override_service_response" ? serviceError : participantError
    );
    autoResize(activeTextarea);
    modal.hide();
  });

  // Observe theme changes from global toggle (in base.html)
  const observer = new MutationObserver(() => {
    if (cm) cm.setOption("theme", getTheme());
  });
  observer.observe(document.documentElement, { attributes: true, attributeFilter: ["data-bs-theme"] });

    // Prevent invalid submission
  document.querySelector("form").addEventListener("submit", e => {
    const sValid = validateJSON(serviceInput, serviceError);
    const pValid = validateJSON(participantInput, participantError);
    if (!sValid || !pValid) {
      e.preventDefault();
      alert("Please fix invalid JSON before saving.");
    }
  });

  // === Clear All buttons for multiselects (with auto-disable + tooltip) ===
  document.querySelectorAll(".clear-multiselect").forEach(btn => {
    const targetId = btn.getAttribute("data-target-id");
    const select = document.getElementById(targetId);
    if (!select) return;

    // Try to infer label text (e.g., "Protocols" or "Call Directions")
    const label = document.querySelector(`label[for="${targetId}"]`);
    const fieldName = label ? label.textContent.trim() : "field";

    // Initialize Bootstrap tooltip
    btn.setAttribute("data-bs-toggle", "tooltip");
    btn.setAttribute("data-bs-placement", "top");
    const tooltip = new bootstrap.Tooltip(btn);

    function updateButtonState() {
      const anySelected = Array.from(select.options).some(opt => opt.selected);
      btn.disabled = !anySelected;
      btn.classList.toggle("btn-outline-secondary", anySelected);
      btn.classList.toggle("btn-outline-light", !anySelected);
      btn.setAttribute(
        "title",
        anySelected ? `Clear all ${fieldName}` : `No ${fieldName.toLowerCase()} selected`
      );
      tooltip.dispose(); // Refresh tooltip to update text
      new bootstrap.Tooltip(btn);
    }

    // Initial state
    updateButtonState();

    // Watch for user selection changes
    select.addEventListener("change", updateButtonState);

    // Click handler
    btn.addEventListener("click", () => {
      Array.from(select.options).forEach(opt => (opt.selected = false));
      updateButtonState();

      // Visual feedback
      btn.classList.add("btn-success");
      btn.textContent = "âœ… Cleared";
      setTimeout(() => {
        btn.classList.remove("btn-success");
        btn.textContent = "ðŸ§¹ Clear";
        updateButtonState();
      }, 1000);
    });
  });
});
</script>


{% endblock %}
