{% extends "policy_router/base.html" %}
{% block title %}Rules{% endblock %}
{% block content %}

<h2 class="mb-4">Policy Proxy Rules</h2>

<!-- Filter Card -->
<div class="card mb-4">
  <div class="card-header">
    <strong>Filter Rules</strong>
  </div>
  <div class="card-body">
    <form method="get" class="row g-3 align-items-end">
      <div class="col-md-4">
        <label class="form-label">Protocols</label>
        <select name="protocols" class="form-select" multiple>
          {% for key, label in protocol_choices %}
            <option value="{{ key }}" {% if key in filters.protocols %}selected{% endif %}>
              {{ label }}
            </option>
          {% endfor %}
        </select>
        <small class="text-muted">Hold Ctrl (Windows) / Cmd (Mac) to select multiple</small>
      </div>
      <div class="col-md-4">
        <label class="form-label">Call Directions</label>
        <select name="call_directions" class="form-select" multiple>
          {% for key, label in call_direction_choices %}
            <option value="{{ key }}" {% if key in filters.call_directions %}selected{% endif %}>
              {{ label }}
            </option>
          {% endfor %}
        </select>
        <small class="text-muted">Hold Ctrl (Windows) / Cmd (Mac) to select multiple</small>
      </div>
      <div class="col-md-4 d-flex align-items-end">
        <button type="submit" class="btn btn-primary me-2">
          <i class="bi bi-funnel"></i> Filter
        </button>
        <a href="{% url 'policy_router:rule_list' %}" class="btn btn-secondary">
          <i class="bi bi-x-circle"></i> Clear
        </a>
      </div>
    </form>
  </div>
</div>

<!-- Add Rule -->
<div class="mb-3">
  <a href="{% url 'policy_router:rule_create' %}" class="btn btn-success">
    <i class="bi bi-plus-circle"></i> Add Rule
  </a>
</div>

<div class="mb-3 text-end">
  <a href="{% url 'policy_router:rule_resequence' %}" class="btn btn-outline-secondary btn-sm">
    üîÑ Resequence Priorities
  </a>
</div>

<!-- Rules Table -->
<div class="card">
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover table-bordered table-striped align-middle mb-0">
        <thead class="table-dark">
          <tr>
            <th style="width: 2rem;"></th> <!-- drag handle -->
            <th>Name</th>
            <th>Regex</th>
            <th>Priority</th>
            <th>Active</th>
            <th>Protocols</th>
            <th>Call Directions</th>
            <th>Service Target</th>
            <th>Participant Target</th>
            <th>Updated</th>
            <th class="text-center">Actions</th>
          </tr>
        </thead>
        <tbody id="rules-table-body">
          {% for rule in rules %}
          <tr data-id="{{ rule.id }}" style="cursor: grab;">
            <td class="text-muted text-center align-middle">
              <i class="bi bi-grip-vertical"></i>
            </td>
            <td><strong>{{ rule.name }}</strong></td>
            <td><code>{{ rule.regex }}</code></td>
            <td>{{ rule.priority }}</td>
            <td>
              {% if rule.is_active %}
                <span class="badge bg-success">Active</span>
              {% else %}
                <span class="badge bg-secondary">Inactive</span>
              {% endif %}
            </td>
            <td>
              {% if rule.protocols %}
                {% for proto in rule.protocols %}
                  <span class="badge bg-info text-dark">{{ proto }}</span>
                {% endfor %}
              {% else %}
                <span class="text-muted">Any</span>
              {% endif %}
            </td>
            <td>
              {% if rule.call_directions %}
                {% for cd in rule.call_directions %}
                  <span class="badge bg-warning text-dark">{{ cd }}</span>
                {% endfor %}
              {% else %}
                <span class="text-muted">Any</span>
              {% endif %}
            </td>
            <td>
              {% if rule.service_target_url %}
                <a href="{{ rule.service_target_url }}" target="_blank">{{ rule.service_target_url }}</a>
              {% else %}
                <span class="text-muted">N/A</span>
              {% endif %}
            </td>
            <td>
              {% if rule.participant_target_url %}
                <a href="{{ rule.participant_target_url }}" target="_blank">{{ rule.participant_target_url }}</a>
              {% else %}
                <span class="text-muted">N/A</span>
              {% endif %}
            </td>
            <td>{{ rule.updated_at|date:"Y-m-d H:i" }}</td>
            <td class="text-end align-middle">
              <div class="d-flex flex-wrap justify-content-end gap-2">
                <a href="{% url 'policy_router:rule_edit' rule.pk %}" class="btn btn-primary btn-sm flex-fill text-nowrap">
                  <i class="bi bi-pencil"></i> Edit
                </a>
                <a href="{% url 'policy_router:rule_duplicate' rule.pk %}" class="btn btn-outline-secondary btn-sm flex-fill text-nowrap">
                  <i class="bi bi-files"></i> Duplicate
                </a>
                <a href="{% url 'policy_router:rule_delete' rule.pk %}" class="btn btn-danger btn-sm flex-fill text-nowrap">
                  <i class="bi bi-trash"></i> Delete
                </a>
              </div>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="11" class="text-center text-muted py-3">No rules found.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

    </div>
  </div>
</div>
<script>
document.addEventListener("DOMContentLoaded", function() {
  const tbody = document.getElementById("rules-table-body");
  if (!tbody) return;

  // Track current order to detect real changes
  let lastOrder = Array.from(tbody.querySelectorAll("tr")).map(row => row.getAttribute("data-id"));

  Sortable.create(tbody, {
    animation: 150,
    handle: "td:first-child",
    chosenClass: "sortable-chosen",
    dragClass: "sortable-drag",
    ghostClass: "sortable-ghost",

    onStart: function(evt) {
      evt.item.style.cursor = "grabbing";
    },

    onEnd: function(evt) {
      evt.item.style.cursor = "grab";

      const rows = Array.from(tbody.querySelectorAll("tr"));
      const newOrder = rows.map(row => row.getAttribute("data-id"));

      // Skip if order hasn't changed
      if (JSON.stringify(newOrder) === JSON.stringify(lastOrder)) {
        console.log("‚ÑπÔ∏è No change in order ‚Äî skipping update");
        return;
      }

      lastOrder = newOrder;

      const now = new Date();
      const formattedNow = now.toLocaleString();

      // Update displayed priorities and timestamps
      rows.forEach((row, index) => {
        const priorityCell = row.children[3];
        if (priorityCell) priorityCell.textContent = index + 1;

        const updatedCell = row.children[row.children.length - 2];
        if (updatedCell) updatedCell.textContent = formattedNow;

        row.style.transition = "background-color 0.4s";
        row.style.backgroundColor = "#d1e7dd";
        setTimeout(() => (row.style.backgroundColor = ""), 500);
      });

      // Send updated order to backend
      fetch("{% url 'policy_router:rule_reorder' %}", {
        method: "POST",
        headers: {
          "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ order: newOrder })
      })
      .then(r => r.json())
      .then(data => {
        if (data.status === "ok") {
          showToast("‚úÖ Rules reordered successfully");
          // optional small delay to see highlight flash before refresh
          if (data.refresh) {
            setTimeout(() => location.reload(), 800);
          }
        } else {
          showToast("‚ùå " + (data.message || "Error reordering rules"), true);
        }
      })
      .catch(err => showToast("‚ö†Ô∏è Network error: " + err, true));
    }
  });

  // Toast notifications
  const toastContainer = document.createElement("div");
  toastContainer.className = "position-fixed bottom-0 end-0 p-3";
  toastContainer.style.zIndex = "1055";
  document.body.appendChild(toastContainer);

  function showToast(message, isError = false) {
    const toastEl = document.createElement("div");
    toastEl.className = `toast align-items-center text-bg-${isError ? "danger" : "success"} border-0 show shadow`;
    toastEl.role = "alert";
    toastEl.innerHTML = `
      <div class="d-flex">
        <div class="toast-body">${message}</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    `;
    toastContainer.appendChild(toastEl);
    setTimeout(() => toastEl.remove(), 4000);
  }
});
</script>

<style>
/* === Drag & Drop styling === */
tr[data-id] td:first-child {
  cursor: grab;
  text-align: center;
  width: 2rem;
}

.sortable-chosen {
  background-color: #fff3cd !important;
  opacity: 0.95;
}

.sortable-ghost {
  background-color: #e2e3e5 !important;
  opacity: 0.7;
}
</style>

{% endblock %}
