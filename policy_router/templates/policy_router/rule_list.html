{% extends "policy_router/base.html" %}
{% load static dict_extras %}
{% block title %}Rules{% endblock %}
{% block content %}

<h2 class="mb-4">Policy Proxy Rules</h2>

<!-- Filter Card -->
<div class="card mb-4 shadow-sm">
  <div class="card-header d-flex justify-content-between align-items-center">
    <strong>Filter Rules</strong>
    <button class="btn btn-sm btn-outline-secondary" type="button"
            data-bs-toggle="collapse"
            data-bs-target="#filterCardBody"
            aria-expanded="false"
            aria-controls="filterCardBody">
      <i class="bi bi-chevron-down" id="filterToggleIcon"></i>
    </button>
  </div>

  <div class="collapse" id="filterCardBody">
    <div class="card-body">
      <form method="get" class="row g-3 align-items-end">
        <!-- Protocols -->
        <div class="col-md-6">
          <label class="form-label fw-semibold">Protocols</label>
          <select name="protocols" class="form-select" multiple>
            {% for key, label in protocol_choices %}
              <option value="{{ key }}" {% if key in filters.protocols %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
          </select>
          <small class="text-muted">Hold Ctrl (Windows) / Cmd (Mac) to select multiple</small>
        </div>

        <!-- Call Directions -->
        <div class="col-md-6">
          <label class="form-label fw-semibold">Call Directions</label>
          <select name="call_directions" class="form-select" multiple>
            {% for key, label in call_direction_choices %}
              <option value="{{ key }}" {% if key in filters.call_directions %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
          </select>
          <small class="text-muted">Hold Ctrl (Windows) / Cmd (Mac) to select multiple</small>
        </div>

        <!-- Source -->
        <div class="col-md-6">
          <label class="form-label fw-semibold">Source</label>
          <select name="source_match" class="form-select">
            <option value="">All Sources</option>
            <option value="__any__" {% if filters.source_match == "__any__" %}selected{% endif %}>
              (No Source Configured)
            </option>
            {% for src in distinct_sources %}
              <option value="{{ src }}" {% if filters.source_match == src %}selected{% endif %}>
                {{ src }}
              </option>
            {% endfor %}
          </select>
        </div>

        <!-- Buttons -->
        <div class="col-md-6 d-flex align-items-end justify-content-end">
          <button type="submit" class="btn btn-primary me-2">
            <i class="bi bi-funnel"></i> Filter
          </button>
          <a href="{% url 'policy_router:rule_list' %}" class="btn btn-secondary">
            <i class="bi bi-x-circle"></i> Clear
          </a>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Add + Search -->
<div class="d-flex justify-content-between align-items-center mb-3">
  <a href="{% url 'policy_router:rule_create' %}" class="btn btn-success btn-sm">
    <i class="bi bi-plus-circle"></i> Add Rule
  </a>
  <input type="text" id="ruleSearch" class="form-control form-control-sm" placeholder="üîç Search rules..." style="width: 250px;">
</div>

<div class="mb-3 text-end">
  <a href="{% url 'policy_router:rule_resequence' %}" class="btn btn-outline-secondary btn-sm">
    üîÑ Resequence Priorities
  </a>
  <a href="{% url 'policy_router:rule_check_duplicates' %}" class="btn btn-outline-warning btn-sm">
    ‚ö†Ô∏è Check Duplicates
  </a>
</div>

<!-- Rules Table -->
<div class="d-flex justify-content-between align-items-center mb-2">
  <h5 class="mb-0">Rules</h5>
  <small class="text-muted">Scroll horizontally to view full details</small>
</div>

<div class="card">
  <div class="card-body p-0">
    <div class="table-responsive position-relative">
      <table class="table table-hover table-bordered table-striped align-middle mb-0 rules-table">
        <thead class="table-dark">
          <tr>
            <th style="width: 2rem;"></th>
            <th>Hits</th>
            <th>Last Matched</th>
            <th>Name</th>
            <th>Source</th>
            <th>Regex</th>
            <th>Priority</th>
            <th>Active</th>
            <th>Protocols</th>
            <th>Call Directions</th>
            <th>Service Target</th>
            <th>Participant Target</th>
            <th>Updated</th>
            <th class="text-center">Actions</th>
          </tr>
        </thead>
        <tbody id="rules-table-body">
          {% for rule in rules %}
          <tr data-id="{{ rule.id }}"
              data-name="{{ rule.name|lower }}"
              data-regex="{{ rule.regex|lower }}"
              data-service="{{ rule.service_target_url|default_if_none:''|lower }}"
              data-participant="{{ rule.participant_target_url|default_if_none:''|lower }}"
              style="cursor: grab;">
            <td class="text-muted text-center align-middle">
              <i class="bi bi-grip-vertical"></i>
            </td>
            <td>{{ rule.match_count|default:0 }}</td>
            <td>
              {% if rule.last_matched_at %}
                {{ rule.last_matched_at|date:"Y-m-d H:i" }}
              {% else %}
                <span class="text-muted">Never</span>
              {% endif %}
            </td>
            <td>
              <strong>
                {{ rule.name }}
                {% if rule.id in duplicate_ids %}
                  <span
                    class="badge bg-warning text-dark ms-1"
                    title="Overlaps with: {{ duplicate_map|get_item:rule.id|join:', ' }}"
                  >
                    ‚ö†Ô∏è
                  </span>
                {% endif %}
              </strong>
            </td>
            <td>
              {% if rule.source_match %}
                <span class="badge bg-primary text-light">{{ rule.source_match }}</span>
              {% else %}
                <span class="text-muted">Any</span>
              {% endif %}
            </td>
            <td><code>{{ rule.regex }}</code></td>
            <td>{{ rule.priority }}</td>
            <td>
              {% if rule.is_active %}
                <span class="badge bg-success">Active</span>
              {% else %}
                <span class="badge bg-secondary">Inactive</span>
              {% endif %}
            </td>
            <td>
              {% if rule.protocols %}
                {% for proto in rule.protocols %}
                  <span class="badge bg-info text-dark">{{ proto }}</span>
                {% endfor %}
              {% else %}
                <span class="text-muted">Any</span>
              {% endif %}
            </td>
            <td>
              {% if rule.call_directions %}
                {% for cd in rule.call_directions %}
                  <span class="badge bg-warning text-dark">{{ cd }}</span>
                {% endfor %}
              {% else %}
                <span class="text-muted">Any</span>
              {% endif %}
            </td>
            <td>
              {% if rule.service_target_url %}
                <a href="{{ rule.service_target_url }}" target="_blank">{{ rule.service_target_url }}</a>
              {% else %}
                <span class="text-muted">N/A</span>
              {% endif %}
            </td>
            <td>
              {% if rule.participant_target_url %}
                <a href="{{ rule.participant_target_url }}" target="_blank">{{ rule.participant_target_url }}</a>
              {% else %}
                <span class="text-muted">N/A</span>
              {% endif %}
            </td>
            <td>{{ rule.updated_at|date:"Y-m-d H:i" }}</td>
            <td class="text-end align-middle">
              <div class="d-flex flex-wrap justify-content-end gap-2">
                <a href="{% url 'policy_router:rule_edit' rule.pk %}" class="btn btn-primary btn-sm flex-fill text-nowrap">
                  <i class="bi bi-pencil"></i> Edit
                </a>
                <a href="{% url 'policy_router:rule_duplicate' rule.pk %}" class="btn btn-outline-secondary btn-sm flex-fill text-nowrap">
                  <i class="bi bi-files"></i> Duplicate
                </a>
                <a href="{% url 'policy_router:rule_delete' rule.pk %}" class="btn btn-danger btn-sm flex-fill text-nowrap">
                  <i class="bi bi-trash"></i> Delete
                </a>
              </div>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="11" class="text-center text-muted py-3">No rules found.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Pagination -->
<div id="pagination" class="mt-3 text-center"></div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const tbody = document.getElementById("rules-table-body");
  const rows = Array.from(tbody.querySelectorAll("tr[data-id]"));
  const searchInput = document.getElementById("ruleSearch");
  const pagination = document.getElementById("pagination");
  const pageSize = 10;
  let currentPage = parseInt(localStorage.getItem("rulesPage") || "1");
  searchInput.value = localStorage.getItem("rulesSearch") || "";
  const toggleButton = document.querySelector("[data-bs-target='#filterCardBody']");
  const icon = document.getElementById("filterToggleIcon");
  const collapseEl = document.getElementById("filterCardBody");

  collapseEl.addEventListener("show.bs.collapse", () => {
    icon.classList.remove("bi-chevron-down");
    icon.classList.add("bi-chevron-up");
  });

  collapseEl.addEventListener("hide.bs.collapse", () => {
    icon.classList.remove("bi-chevron-up");
    icon.classList.add("bi-chevron-down");
  });
  // --- Filter logic ---
  function getFilteredRows() {
    const q = searchInput.value.toLowerCase();
    return rows.filter(row =>
      row.dataset.name.includes(q) ||
      row.dataset.regex.includes(q) ||
      row.dataset.service.includes(q) ||
      row.dataset.participant.includes(q)
    );
  }

  function renderPage(filteredRows) {
    const totalPages = Math.ceil(filteredRows.length / pageSize) || 1;
    currentPage = Math.min(currentPage, totalPages);
    localStorage.setItem("rulesPage", currentPage);
    tbody.innerHTML = "";
    const start = (currentPage - 1) * pageSize;
    const end = start + pageSize;
    filteredRows.slice(start, end).forEach(r => tbody.appendChild(r));
    renderPagination(totalPages);
  }

  function renderPagination(totalPages) {
    pagination.innerHTML = "";
    if (totalPages <= 1) return;
    for (let i = 1; i <= totalPages; i++) {
      const btn = document.createElement("button");
      btn.className = "btn btn-sm " + (i === currentPage ? "btn-primary" : "btn-outline-secondary");
      btn.textContent = i;
      btn.addEventListener("click", () => {
        currentPage = i;
        renderPage(getFilteredRows());
      });
      pagination.appendChild(btn);
    }
  }

  function applySearch() {
    localStorage.setItem("rulesSearch", searchInput.value);
    currentPage = 1;
    renderPage(getFilteredRows());
  }

  searchInput.addEventListener("input", applySearch);
  renderPage(getFilteredRows());

  let lastOrder = rows.map(row => row.getAttribute("data-id"));
  Sortable.create(tbody, {
    animation: 150,
    handle: "td:first-child",
    onEnd: function(evt) {
      const newOrder = Array.from(tbody.querySelectorAll("tr")).map(r => r.dataset.id);
      if (JSON.stringify(newOrder) === JSON.stringify(lastOrder)) return;
      lastOrder = newOrder;
      fetch("{% url 'policy_router:rule_reorder' %}", {
        method: "POST",
        headers: {
          "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ order: newOrder })
      });
    }
  });
});
</script>

<style>
  #rules-table-body tr { transition: all 0.2s ease-in-out; }
  .sortable-chosen { background-color: #fff3cd !important; opacity: 0.95; }
  .sortable-ghost { background-color: #e2e3e5 !important; opacity: 0.7; }
  .rules-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
  }

  /* Keep first (grip) and last (actions) columns fixed */
  .rules-table th:first-child,
  .rules-table td:first-child {
    position: sticky;
    left: 0;
    background: var(--bs-body-bg);
    z-index: 2;
    box-shadow: 2px 0 4px rgba(0,0,0,0.1);
  }

  .rules-table th:last-child,
  .rules-table td:last-child {
    position: sticky;
    right: 0;
    background: var(--bs-body-bg);
    z-index: 2;
    box-shadow: -2px 0 4px rgba(0,0,0,0.1);
  }

  /* Better column sizing */
  .rules-table th, .rules-table td {
    white-space: nowrap;
    vertical-align: middle;
  }

  .rules-table td code {
    font-size: 0.85rem;
  }

  .rules-table .btn-group,
  .rules-table .d-flex {
    flex-wrap: nowrap;
    gap: 0.25rem;
  }

  /* Reduce button padding to fit more */
  .rules-table .btn-sm {
    padding: 0.25rem 0.4rem;
    font-size: 0.8rem;
  }

  /* Hover highlight across full width */
  .rules-table tbody tr:hover {
    background-color: rgba(25, 135, 84, 0.05);
  }
  /* Match sticky header cells with dark header background */
  .rules-table thead th:first-child,
  .rules-table thead th:last-child {
    background-color: var(--bs-dark) !important;
    color: var(--bs-light) !important;
    z-index: 3; /* Ensure above scroll shadows */
  }

  /* Optional: keep the subtle shadow to separate fixed columns */
  .rules-table th:first-child {
    box-shadow: 2px 0 4px rgba(0,0,0,0.2);
  }

  .rules-table th:last-child {
    box-shadow: -2px 0 4px rgba(0,0,0,0.2);
  }

</style>

{% endblock %}
